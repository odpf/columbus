"use strict";(self.webpackChunkcompass=self.webpackChunkcompass||[]).push([[300],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,h=d["".concat(l,".").concat(m)]||d[m]||p[m]||s;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var c=2;c<s;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4980:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return p}});var a=n(7462),r=n(3366),s=(n(7294),n(3905)),i=["components"],o={},l="Internals",c={unversionedId:"concepts/internals",id:"concepts/internals",title:"Internals",description:"This document details information about how Compass interfaces with elasticsearch. It is meant to give an overview of how some concepts work internally, to help streamline understanding of how things work under the hood.",source:"@site/docs/concepts/internals.md",sourceDirName:"concepts",slug:"/concepts/internals",permalink:"/compass/concepts/internals",draft:!1,editUrl:"https://github.com/raystack/compass/edit/master/docs/docs/concepts/internals.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Architecture",permalink:"/compass/concepts/architecture"},next:{title:"Compass",permalink:"/compass/reference/api"}},u={},p=[{value:"Index Setup",id:"index-setup",level:2},{value:"Postgres",id:"postgres",level:2},{value:"Search",id:"search",level:2}],d={toc:p};function m(e){var t=e.components,n=(0,r.Z)(e,i);return(0,s.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"internals"},"Internals"),(0,s.kt)("p",null,"This document details information about how Compass interfaces with elasticsearch. It is meant to give an overview of how some concepts work internally, to help streamline understanding of how things work under the hood."),(0,s.kt)("h2",{id:"index-setup"},"Index Setup"),(0,s.kt)("p",null,"There is a migration command in compass to setup all storages. The indices are configured with a camel case tokenizer, to support proper lexing of some resources that use camel case in their nomenclature ","(","protobuf names for instance",")",". Given below is a sample of the index settings that are used:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'// PUT http://${ES_HOST}/{index}\n{\n        "mappings": {},         // used for boost\n        "aliases": {            // all indices are aliased to the "universe" index\n            "universe": {}\n        },\n        "settings": {           // configuration for handling camel case text\n            "analysis": {\n                "analyzer": {\n                    "default": {\n                        "type": "pattern",\n                        "pattern": "([^\\\\p{L}\\\\d]+)|(?<=\\\\D)(?=\\\\d)|(?<=\\\\d)(?=\\\\D)|(?<=[\\\\p{L}&&[^\\\\p{Lu}]])(?=\\\\p{Lu})|(?<=\\\\p{Lu})(?=\\\\p{Lu}[\\\\p{L}&&[^\\\\p{Lu}]])"\n                    }\n                }\n            }\n        }\n    }\n')),(0,s.kt)("p",null,"One shared index is created for all services and tenants but each request(read/write) is routed to a unique shard for each tenant. Compass categorize tenants into two tires, ",(0,s.kt)("inlineCode",{parentName:"p"},"shared")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"dedicated"),". For shared tenants, all the requests will be routed by namespace id over a single shard in an index. For dedicated tenants, each tenant will have its own index. Note, a single index will have N number of ",(0,s.kt)("inlineCode",{parentName:"p"},"types")," same as the number of ",(0,s.kt)("inlineCode",{parentName:"p"},"Services")," supported in Compass. This design will ensure, all the document insert/query requests are only confined to a single shard(in case of shared) or a single index(in case of dedicated).\nDetails on why we did this is available at ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/raystack/compass/issues/208"},"issue #208"),"."),(0,s.kt)("h2",{id:"postgres"},"Postgres"),(0,s.kt)("p",null,"To enforce multi-tenant restrictions at the database level, ",(0,s.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/ddl-rowsecurity.html"},"Row Level Security")," is used. RLS requires Postgres users used for application database connection not to be a table owner or a superuser else all RLS are bypassed by default. That means a Postgres user that is migrating the application and a user that is used to serve the app should both be different."),(0,s.kt)("p",null,"To create a postgres user"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sql"},'CREATE USER "compass_user" WITH PASSWORD \'compass\';\nGRANT CONNECT ON DATABASE "compass" TO "compass_user";\nGRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "compass_user";\nGRANT ALL ON ALL SEQUENCES IN SCHEMA public TO "compass_user";\nGRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO "compass_user";\n\nALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES\nON TABLES TO "compass_user";\nALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT USAGE ON SEQUENCES TO "compass_user";\nALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT EXECUTE ON FUNCTIONS TO "compass_user";\n')),(0,s.kt)("p",null,"A middleware for grpc looks for ",(0,s.kt)("inlineCode",{parentName:"p"},"x-namespace-id")," header to extract tenant id if not found falls back to ",(0,s.kt)("inlineCode",{parentName:"p"},"default")," namespace.\nSame could be passed in a ",(0,s.kt)("inlineCode",{parentName:"p"},"jwt token")," of Authentication Bearer with ",(0,s.kt)("inlineCode",{parentName:"p"},"namespace_id")," as a claim."),(0,s.kt)("h2",{id:"search"},"Search"),(0,s.kt)("p",null,"We use elasticsearch's ",(0,s.kt)("inlineCode",{parentName:"p"},"multi_match")," search for running our queries. Depending on whether there are additional filter's specified during search, we augment the query with a custom script query that filter's the result set."),(0,s.kt)("p",null,"The script filter is designed to match a document if:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"the document contains the filter key and it's value matches the filter value OR"),(0,s.kt)("li",{parentName:"ul"},"the document doesn't contain the filter key at all")),(0,s.kt)("p",null,"To demonstrate, the following API call:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-text"},"$ curl http://localhost:8080/v1beta1/search?text=log&filter[landscape]=id\n")),(0,s.kt)("p",null,"is internally translated to the following elasticsearch query"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'{\n    "query": {\n        "bool": {\n            "must": {\n                "multi_match": {\n                    "query": "log"\n                }\n            },\n            "filter": [{\n                "script": {\n                    "script": {\n                        "source": "doc.containsKey(\\"landscape.keyword\\") == false || doc[\\"landscape.keyword\\"].value == \\"id\\""\n                    }\n                }\n            }]\n        }\n    }\n}\n')),(0,s.kt)("p",null,"Compass also supports filter with fuzzy match with ",(0,s.kt)("inlineCode",{parentName:"p"},"query")," query params. The script query is designed to match a document if:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"the document contains the filter key and it's value is fuzzily matches the ",(0,s.kt)("inlineCode",{parentName:"li"},"query")," value")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-text"},"$ curl http://localhost:8080/v1beta1/search?text=log&filter[landscape]=id\n")),(0,s.kt)("p",null,"is internally translated to the following elasticsearch query"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'{\n   "query":{\n      "bool":{\n         "filter":{\n            "match":{\n               "description":{\n                  "fuzziness":"AUTO",\n                  "query":"test"\n               }\n            }\n         },\n         "should":{\n            "bool":{\n               "should":[\n                  {\n                     "multi_match":{\n                        "fields":[\n                           "urn^10",\n                           "name^5"\n                        ],\n                        "query":"log"\n                     }\n                  },\n                  {\n                     "multi_match":{\n                        "fields":[\n                           "urn^10",\n                           "name^5"\n                        ],\n                        "fuzziness":"AUTO",\n                        "query":"log"\n                     }\n                  },\n                  {\n                     "multi_match":{\n                        "fields":[\n\n                        ],\n                        "fuzziness":"AUTO",\n                        "query":"log"\n                     }\n                  }\n               ]\n            }\n         }\n      }\n   },\n   "min_score":0.01\n}\n')))}m.isMDXComponent=!0}}]);